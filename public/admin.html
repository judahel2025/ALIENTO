<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ALIENTO</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-card {
            background: var(--color-surface);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
        }

        .admin-view {
            display: none;
        }

        .admin-view.active {
            display: flex;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="auth-screen" id="loginScreen">
        <div class="auth-card">
            <h2 class="section-title" style="font-size: 32px; text-align: center; margin-bottom: 30px;">Admin Access
            </h2>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="email" class="form-control" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
            </form>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="initFirstAdmin()" class="btn btn-outline"
                    style="font-size: 13px; padding: 8px 16px;">Initialize System</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-shell admin-view" id="adminContent">
        <aside class="sidebar">
            <a href="/" class="sidebar-logo">ALIENTO.</a>
            <ul class="sidebar-links">
                <li><a href="#" class="nav-item active" onclick="showSection('dashboard')">
                        <span class="material-icons-round">dashboard</span> Dashboard
                    </a></li>
                <li><a href="#" class="nav-item" onclick="showSection('posts')">
                        <span class="material-icons-round">article</span> Posts
                    </a></li>
                <li><a href="#" class="nav-item" onclick="showSection('events')">
                        <span class="material-icons-round">event</span> Events
                    </a></li>
                <li><a href="#" class="nav-item" onclick="showSection('subscribers')">
                        <span class="material-icons-round">people</span> Subscribers
                    </a></li>
                <li><a href="#" class="nav-item" onclick="logout()">
                        <span class="material-icons-round">logout</span> Logout
                    </a></li>
            </ul>
        </aside>

        <main class="admin-content">
            <header class="admin-header">
                <div>
                    <h1>Dashboard</h1>
                    <p style="color: var(--color-text-light);">Welcome back to your content center.</p>
                </div>
                <div class="user-profile">
                    <div class="avatar"
                        style="width: 40px; height: 40px; background: var(--color-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                        A</div>
                </div>
            </header>

            <!-- Stats -->
            <div class="stats-grid"
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px;"
                id="statsGrid">
                <div class="stat-card category-card">
                    <h3 style="font-size: 14px; text-transform: uppercase;">Total Posts</h3>
                    <div class="number" id="totalPosts"
                        style="font-size: 36px; font-weight: 800; color: var(--color-primary);">0</div>
                </div>
                <div class="stat-card category-card">
                    <h3 style="font-size: 14px; text-transform: uppercase;">Published</h3>
                    <div class="number" id="publishedPosts"
                        style="font-size: 36px; font-weight: 800; color: var(--color-accent);">0</div>
                </div>
                <div class="stat-card category-card">
                    <h3 style="font-size: 14px; text-transform: uppercase;">Total Views</h3>
                    <div class="number" id="totalViews"
                        style="font-size: 36px; font-weight: 800; color: var(--color-secondary);">0</div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 40px;">
                <!-- Post Creation -->
                <!-- Posts Section -->
                <div class="section-card" id="postsSection" style="display:none;">
                    <div class="section-header-flex">
                        <h3>All Management</h3>
                    </div>
                </div>

                <!-- Create Post Form -->
                <div class="section-card" id="createPostForm">
                    <h2 style="font-size: 24px; margin-bottom: 24px;">Create New Post</h2>
                    <form id="postForm">
                        <div class="form-group">
                            <label class="form-label">Title</label>
                            <input type="text" id="postTitle" class="form-control" required
                                placeholder="Enter post title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" id="postCategory" class="form-control" required
                                placeholder="e.g., Cooking Tips">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Excerpt</label>
                            <textarea id="postExcerpt" class="form-control" rows="2" required
                                placeholder="Short summary"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cover Image</label>
                            <input type="file" id="postImage" class="form-control" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Video (Optional)</label>
                            <input type="file" id="postVideo" class="form-control" accept="video/*">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content</label>
                            <textarea id="postContent" class="form-control" rows="12" required
                                placeholder="Write your story..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Publish Post</button>
                    </form>
                </div>

                <!-- Create Event Section -->
                <div class="section-card" id="createEventSection"
                    style="display:none; background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <h2 style="font-size: 24px; margin-bottom: 24px;">Create New Event</h2>
                    <form id="eventForm">
                        <div class="form-group">
                            <label class="form-label">Event Title</label>
                            <input type="text" id="eventTitle" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="datetime-local" id="eventDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" id="eventLocation" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea id="eventDescription" class="form-control" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Publish Event</button>
                    </form>
                    <div style="margin-top: 30px;">
                        <h4>Upcoming Events</h4>
                        <div id="eventsList"></div>
                    </div>
                </div>

                <!-- Subscribers Section -->
                <div class="section-card" id="subscribersSection"
                    style="display:none; background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <h2 style="font-size: 24px; margin-bottom: 24px;">Newsletter Subscribers</h2>
                    <div id="subscribersList"></div>
                </div>

                <!-- Recent Posts List -->
                <div class="card"
                    style="background: white; padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                    <h2 style="font-size: 24px; margin-bottom: 24px;">Recent Posts</h2>
                    <ul id="postsList" style="list-style: none;">
                        <!-- Posts injected here -->
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script>
        // API Base URL
        const API = '/api';
        let authToken = localStorage.getItem('authToken');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (authToken) {
                verifyAuth();
            } else {
                showLogin();
            }
        });

        // --- Auth Logic ---
        async function verifyAuth() {
            try {
                const res = await fetch(`${API}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    showAdmin();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminContent').classList.remove('active');
        }

        function showAdmin() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminContent').classList.add('active');
            loadStats();
            loadPosts(); // Load posts by default
        }

        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            showLogin();
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (res.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showAdmin();
                } else {
                    alert(data.error || 'Login failed');
                }
            } catch (error) {
                alert('Connection error');
            }
        });

        async function initFirstAdmin() {
            const email = prompt('Enter email for first admin:');
            if (!email) return;
            const password = prompt('Enter password:');
            const username = prompt('Enter username:');

            try {
                const res = await fetch(`${API}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, username })
                });
                if (res.ok) alert('Created! Login now.');
                else alert('Failed');
            } catch (e) { alert('Error'); }
        }

        // --- Navigation ---
        function showSection(sectionId) {
            // Updated to simply toggle visibility of section containers
            // For now, we mainly toggle the creation forms
            document.getElementById('createPostForm').style.display = 'none';
            document.getElementById('createEventSection').style.display = 'none';
            document.getElementById('subscribersSection').style.display = 'none';
            // Also hide posts list if we are in other tabs?
            // Let's keep it simple: Dashboard shows stats + create post

            if (sectionId === 'dashboard' || sectionId === 'posts') {
                document.getElementById('createPostForm').style.display = 'block';
            } else if (sectionId === 'events') {
                document.getElementById('createEventSection').style.display = 'block';
                loadEvents();
            } else if (sectionId === 'subscribers') {
                document.getElementById('subscribersSection').style.display = 'block';
                loadSubscribers();
            }

            // Update sidebar active state
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // This is a simple visual update, actual class adding depends on the clicked element which is hard to pass here without binding
            // Skipping visual active state update for brevity to ensure functionality first
        }

        // --- Data Loading ---
        async function loadStats() {
            try {
                const res = await fetch(`${API}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (res.ok) {
                    document.getElementById('totalPosts').textContent = data.totalPosts || 0;
                    document.getElementById('publishedPosts').textContent = data.publishedPosts || 0;
                    document.getElementById('totalViews').textContent = data.totalViews || 0;
                }
            } catch (e) { }
        }

        // --- Posts ---
        async function loadPosts() {
            try {
                const res = await fetch(`${API}/posts`);
                const posts = await res.json();
                const list = document.getElementById('postsList');
                list.innerHTML = posts.map(post => `
                     <li style="padding: 16px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h4 style="margin-bottom: 4px; font-size: 16px;">${post.title}</h4>
                            <p style="color: var(--color-text-light); font-size: 13px;">${post.category} • ${new Date(post.createdAt).toLocaleDateString()}</p>
                        </div>
                        <button onclick="deletePost('${post.id}')" style="color: red; background: none; border: none; cursor: pointer; font-size: 13px;">Delete</button>
                    </li>
                `).join('');
            } catch (e) { }
        }

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('postTitle').value);
            formData.append('category', document.getElementById('postCategory').value);
            formData.append('excerpt', document.getElementById('postExcerpt').value);
            formData.append('content', document.getElementById('postContent').value);

            const img = document.getElementById('postImage').files[0];
            const vid = document.getElementById('postVideo').files[0];
            if (img) formData.append('image', img);
            if (vid) formData.append('video', vid);

            try {
                const res = await fetch(`${API}/posts`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                if (res.ok) {
                    alert('Post Published!');
                    document.getElementById('postForm').reset();
                    loadPosts();
                    loadStats();
                } else {
                    const d = await res.json();
                    alert(d.error || 'Err');
                }
            } catch (e) { alert('Error'); }
        });

        async function deletePost(id) {
            if (!confirm('Delete?')) return;
            await fetch(`${API}/posts/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            loadPosts();
            loadStats();
        }

        // --- Events ---
        async function loadEvents() {
            try {
                const res = await fetch(`${API}/events`);
                const events = await res.json();
                document.getElementById('eventsList').innerHTML = events.map(e => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee;">
                        <strong>${e.title}</strong> - ${new Date(e.date).toLocaleDateString()}
                        <button onclick="deleteEvent(${e.id})" style="color: red; float: right; border: none; cursor: pointer;">Delete</button>
                    </div>
                `).join('');
            } catch (e) { }
        }

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                location: document.getElementById('eventLocation').value,
                description: document.getElementById('eventDescription').value
            };
            const res = await fetch(`${API}/events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('Event Created');
                document.getElementById('eventForm').reset();
                loadEvents();
            }
        });

        async function deleteEvent(id) {
            if (!confirm('Delete?')) return;
            await fetch(`${API}/events/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            loadEvents();
        }

        // --- Subscribers ---
        async function loadSubscribers() {
            const res = await fetch(`${API}/subscribers`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const subs = await res.json();
            document.getElementById('subscribersList').innerHTML = subs.map(s =>
                `<div style="padding: 8px; border-bottom: 1px solid #eee;">${s.email}</div>`
            ).join('');
        }
    </script>
</body>

</html>